<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BerkoTNF Performance Rating Validation Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #1a202c;
            margin-bottom: 10px;
        }
        
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
            background: #4299e1;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .file-input-wrapper:hover {
            background: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.3);
        }
        
        .file-input-wrapper:active {
            transform: translateY(0);
        }
        
        .file-input-wrapper input[type=file] {
            display: none;
        }
        
        .filters {
            margin-left: 15px;
            display: inline-block;
        }
        
        .filters select, .filters input {
            padding: 6px 12px;
            margin: 0 5px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
        }
        
        .player-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .player-header {
            padding: 15px 20px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .player-name {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
        }
        
        .player-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #718096;
        }
        
        .tier-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .tier-new { background: #bee3f8; color: #2c5282; }
        .tier-developing { background: #faf089; color: #744210; }
        .tier-established { background: #c6f6d5; color: #22543d; }
        
        .current-ratings {
            padding: 15px 20px;
            background: #f8f9fa;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .rating-item {
            text-align: center;
        }
        
        .rating-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .rating-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .rating-percentage {
            font-size: 14px;
            color: #4a5568;
            margin-top: 2px;
        }
        
        .periods-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .periods-table th {
            background: #edf2f7;
            padding: 12px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .periods-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }
        
        .periods-table tr:hover {
            background: #f8f9fa;
        }
        
        .period-recent-1 { border-left: 4px solid #48bb78; }
        .period-recent-2 { border-left: 4px solid #ed8936; }
        .period-old { border-left: 4px solid #e2e8f0; }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .alert-warning {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            color: #744210;
        }
        
        .alert-danger {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        
        .alert-info {
            background: #ebf8ff;
            border: 1px solid #63b3ed;
            color: #2a4365;
        }
        
        .metric-good { color: #22543d; font-weight: 600; }
        .metric-warning { color: #744210; font-weight: 600; }
        .metric-danger { color: #742a2a; font-weight: 600; }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .current-ratings {
                grid-template-columns: 1fr;
            }
            
            .periods-table {
                font-size: 12px;
            }
            
            .periods-table th,
            .periods-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Performance Rating Validation Dashboard</h1>
            <p>Upload CSV export from Supabase to validate your performance rating algorithm</p>
        </div>
        
        <div class="controls">
            <div class="file-input-wrapper" onclick="document.getElementById('csvFile').click()">
                <input type="file" id="csvFile" accept=".csv" style="display: none;" />
                Upload CSV Data
            </div>
            
            <div class="filters">
                <select id="tierFilter">
                    <option value="">All Tiers</option>
                    <option value="NEW">NEW Players</option>
                    <option value="DEVELOPING">DEVELOPING Players</option>
                    <option value="ESTABLISHED">ESTABLISHED Players</option>
                </select>
                
                <input type="text" id="nameFilter" placeholder="Search player name..." />
                
                <select id="issueFilter">
                    <option value="">All Players</option>
                    <option value="issues">Only Show Issues</option>
                </select>
            </div>
        </div>
        
        <div id="summary" class="stats-summary" style="display: none;"></div>
        <div id="alerts" style="display: none;"></div>
        <div id="content">
            <div class="loading">
                <p>üëÜ Upload a CSV file exported from the simple_rating_validation.sql query</p>
                <p style="margin-top: 10px; font-size: 14px; color: #a0aec0;">
                    Run the query in Supabase SQL editor, then export results as CSV
                </p>
                <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; font-size: 13px;">
                    <strong>üìä Reading the Dashboard:</strong><br>
                    ‚Ä¢ Periods ordered chronologically (most recent first)<br>
                    ‚Ä¢ üéØ = Used for trend calculation<br>
                    ‚Ä¢ ‚úÖ = Qualifies but not used<br>
                    ‚Ä¢ ‚ùå = Below tier minimum games requirement<br>
                    ‚Ä¢ <span style="border-left: 3px solid #48bb78; padding-left: 5px;">Green border</span> = Primary trend period<br>
                    ‚Ä¢ <span style="border-left: 3px solid #ed8936; padding-left: 5px;">Orange border</span> = Secondary trend period
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let processedData = [];
        
        document.getElementById('csvFile').addEventListener('change', handleFile);
        document.getElementById('tierFilter').addEventListener('change', applyFilters);
        document.getElementById('nameFilter').addEventListener('input', applyFilters);
        document.getElementById('issueFilter').addEventListener('change', applyFilters);
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('File selected:', file.name);
            
            // Show loading state
            document.getElementById('content').innerHTML = '<div class="loading">üìä Processing CSV data...</div>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('File loaded, parsing CSV...');
                    allData = parseCSV(e.target.result);
                    console.log('CSV parsed, rows:', allData.length);
                    
                    processedData = processData(allData);
                    console.log('Data processed, players:', processedData.length);
                    
                    displaySummary(processedData);
                    displayData(processedData);
                } catch (error) {
                    console.error('Error processing file:', error);
                    document.getElementById('content').innerHTML = 
                        `<div class="alert alert-danger">Error parsing CSV: ${error.message}<br><br>
                        Make sure you exported the CSV from the simple_rating_validation.sql query.</div>`;
                }
            };
            
            reader.onerror = function() {
                document.getElementById('content').innerHTML = 
                    '<div class="alert alert-danger">Error reading file. Please try again.</div>';
            };
            
            reader.readAsText(file);
        }
        
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            return lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                return row;
            });
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        function processData(data) {
            const playerMap = new Map();
            
            // Get league maximums from the data (should be same across all rows)
            const firstRow = data[0] || {};
            const leagueMaxPower = parseFloat(firstRow.league_power_max) || 10; // fallback
            const leagueMaxGoals = parseFloat(firstRow.league_goal_max) || 1.5; // fallback
            
                                console.log('League maximums from CSV:', { power: leagueMaxPower, goals: leagueMaxGoals });
                    console.log('Sample CSV row for league max debugging:', firstRow);
            
            data.forEach(row => {
                const playerName = row.name;
                if (!playerMap.has(playerName)) {
                    const currentPower = parseFloat(row.current_power) || null;
                    const currentGoals = parseFloat(row.current_goals) || null;
                    const currentAttend = parseFloat(row.current_attend) || null;
                    
                    // Calculate UI percentages properly
                    const powerUiPct = currentPower && leagueMaxPower > 0 ? 
                        Math.min(100, Math.round((currentPower / leagueMaxPower) * 100)) : null;
                    const goalsUiPct = currentGoals && leagueMaxGoals > 0 ? 
                        Math.min(100, Math.round((currentGoals / leagueMaxGoals) * 100)) : null;
                        

                        
                    playerMap.set(playerName, {
                        name: playerName,
                        periods: [],
                        // Current ratings (from first row only)
                        currentPower: currentPower,
                        currentGoals: currentGoals,
                        currentAttend: currentAttend,
                        powerUiPct: powerUiPct,
                        goalsUiPct: goalsUiPct,
                        attendUiPct: currentAttend,
                        tier: determineTier(data.filter(d => d.name === playerName)),
                        leagueMaxPower: leagueMaxPower,
                        leagueMaxGoals: leagueMaxGoals
                    });
                }
                
                const player = playerMap.get(playerName);
                player.periods.push({
                    period: row.period,
                    matches: parseInt(row.matches) || 0,
                    ppg: parseFloat(row.ppg) || 0,
                    goalsPerGame: parseFloat(row.goals_per_game) || 0,
                    attendancePct: parseInt(row.attendance_pct) || 0
                });
            });
            
                            // Sort periods by recency and add analysis
                playerMap.forEach(player => {
                    console.log(`Sorting periods for ${player.name}:`, player.periods.map(p => p.period));
                    
                    player.periods.sort((a, b) => {
                        // Create proper date objects for comparison
                        const [aYear, aHalf] = a.period.split('-');
                        const [bYear, bHalf] = b.period.split('-');
                        
                        // Convert to end-of-period dates for proper comparison
                        const aDate = new Date(parseInt(aYear), aHalf === 'H1' ? 5 : 11, aHalf === 'H1' ? 30 : 31); // H1 ends June 30, H2 ends Dec 31
                        const bDate = new Date(parseInt(bYear), bHalf === 'H1' ? 5 : 11, bHalf === 'H1' ? 30 : 31);
                        
                        // Most recent first (descending order)
                        return bDate.getTime() - aDate.getTime();
                    });
                    
                    console.log(`After sorting for ${player.name}:`, player.periods.map(p => p.period));
                
                                    player.totalGames = player.periods.reduce((sum, p) => sum + p.matches, 0);
                    
                    // Determine which periods would be used for trend calculation
                    const tierMinGames = player.tier === 'NEW' ? 3 : player.tier === 'DEVELOPING' ? 6 : 10;
                    const qualifyingPeriods = player.periods.filter(p => p.matches >= tierMinGames);
                    player.trendPeriods = qualifyingPeriods.slice(0, 2); // Most recent 2 qualifying periods
                    player.tierMinGames = tierMinGames;
                    
                    player.issues = detectIssues(player);
            });
            
            return Array.from(playerMap.values()).sort((a, b) => b.totalGames - a.totalGames);
        }
        
        function determineTier(playerRows) {
            const totalGames = playerRows.reduce((sum, row) => sum + (parseInt(row.matches) || 0), 0);
            if (totalGames <= 30) return 'NEW';
            if (totalGames <= 75) return 'DEVELOPING';
            return 'ESTABLISHED';
        }
        
        function detectIssues(player) {
            const issues = [];
            
            // Check for UI percentage over 100%
            if (player.powerUiPct > 100) issues.push('Power rating UI > 100%');
            if (player.goalsUiPct > 100) issues.push('Goals UI > 100%');
            
            // Check for missing current ratings
            if (player.currentPower === null) issues.push('Missing current power rating');
            
            // Check for extreme PPG values
            const extremePPG = player.periods.filter(p => p.ppg > 50 || p.ppg < -20);
            if (extremePPG.length > 0) issues.push('Extreme PPG values detected');
            
                            // Check for inconsistent ratings vs recent performance
                if (player.periods.length >= 2 && player.currentPower !== null) {
                    const recentPPG = player.periods.slice(0, 2).reduce((sum, p) => sum + p.ppg, 0) / 2;
                    const difference = Math.abs(player.currentPower - recentPPG);
                    
                    if (player.tier === 'ESTABLISHED' && difference > 15) {
                        issues.push('Current rating differs significantly from recent performance');
                    }
                    if (player.tier === 'NEW' && difference > 25) {
                        issues.push('New player rating may be too conservative');
                    }
                }
                
                // Check for UI calculation consistency (percentile vs ratio methods)
                if (player.currentPower !== null && player.powerUiPct !== null) {
                    // The dashboard now uses league max ratio, but the app should use percentile
                    // This difference is expected and documented as part of Version 3.4
                    const calculationNote = 'UI percentages now use percentile ranking for consistency';
                }
                
                // Check for potential outlier protection (ESTABLISHED players only)
                if (player.tier === 'ESTABLISHED' && player.periods.length >= 3) {
                    const historicalAvg = player.periods.slice(1).reduce((sum, p) => sum + p.ppg, 0) / (player.periods.length - 1);
                    const recentPPG = player.periods[0].ppg;
                    
                    if (recentPPG < historicalAvg * 0.45) {
                        issues.push('üõ°Ô∏è Outlier protection may have prevented rating crash (recent period 55%+ below historical)');
                    }
                    if (recentPPG > historicalAvg * 2.5) {
                        issues.push('üõ°Ô∏è Outlier protection may have prevented rating spike (recent period 150%+ above historical)');
                    }
                }
            
            return issues;
        }
        
        function displaySummary(data) {
            const summary = document.getElementById('summary');
            const totalPlayers = data.length;
            const playersWithIssues = data.filter(p => p.issues.length > 0).length;
            const avgPowerRating = data.filter(p => p.currentPower !== null)
                .reduce((sum, p) => sum + p.currentPower, 0) / data.filter(p => p.currentPower !== null).length;
            
            const tierCounts = data.reduce((acc, p) => {
                acc[p.tier] = (acc[p.tier] || 0) + 1;
                return acc;
            }, {});
            
            summary.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalPlayers}</div>
                    <div class="stat-label">Total Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${playersWithIssues}</div>
                    <div class="stat-label">Players with Issues</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgPowerRating.toFixed(1)}</div>
                    <div class="stat-label">Avg Power Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${tierCounts.NEW || 0}/${tierCounts.DEVELOPING || 0}/${tierCounts.ESTABLISHED || 0}</div>
                    <div class="stat-label">NEW/DEV/EST</div>
                </div>
            `;
            
            summary.style.display = 'grid';
            
            // Show global alerts if needed
            const alerts = document.getElementById('alerts');
            let alertsHTML = '';
            
            if (playersWithIssues > totalPlayers * 0.2) {
                alertsHTML += '<div class="alert alert-warning">‚ö†Ô∏è More than 20% of players have detected issues. Consider reviewing algorithm parameters.</div>';
            }
            
            const highUIPercentages = data.filter(p => p.powerUiPct > 100 || p.goalsUiPct > 100).length;
            if (highUIPercentages > 0) {
                alertsHTML += `<div class="alert alert-danger">üö® ${highUIPercentages} players have UI percentages over 100%. Check league maximum calculations.</div>`;
            }
            
            if (alertsHTML) {
                alerts.innerHTML = alertsHTML;
                alerts.style.display = 'block';
            }
        }
        
        function displayData(data) {
            const content = document.getElementById('content');
            
            if (data.length === 0) {
                content.innerHTML = '<div class="no-data">No data matches current filters</div>';
                return;
            }
            
            content.innerHTML = data.map(player => `
                <div class="player-card">
                    <div class="player-header">
                        <div>
                            <div class="player-name">${player.name}</div>
                            <div class="player-meta">
                                <span class="tier-badge tier-${player.tier.toLowerCase()}">${player.tier}</span>
                                <span>${player.totalGames} total games</span>
                                <span style="font-size: 12px; color: #718096;">Needs ${player.tierMinGames}+ matches/period</span>
                                ${player.issues.length > 0 ? `<span style="color: #e53e3e;">‚ö†Ô∏è ${player.issues.length} issues</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${player.currentPower !== null ? `
                    <div class="current-ratings">
                        <div class="rating-item">
                            <div class="rating-value ${getRatingClass(player.currentPower, 'power')}">${player.currentPower.toFixed(1)}</div>
                            <div class="rating-label">Power Rating</div>
                            ${player.powerUiPct !== null ? `<div class="rating-percentage">${player.powerUiPct.toFixed(0)}%</div>` : ''}
                        </div>
                        <div class="rating-item">
                            <div class="rating-value ${getRatingClass(player.currentGoals, 'goals')}">${player.currentGoals?.toFixed(2) || 'N/A'}</div>
                            <div class="rating-label">Goal Threat</div>
                            ${player.goalsUiPct !== null ? `<div class="rating-percentage">${player.goalsUiPct.toFixed(0)}%</div>` : ''}
                        </div>
                        <div class="rating-item">
                            <div class="rating-value ${getRatingClass(player.currentAttend, 'attendance')}">${player.currentAttend?.toFixed(0) || 'N/A'}%</div>
                            <div class="rating-label">Participation</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${player.issues.length > 0 ? `
                    <div style="padding: 15px 20px; background: #fef5e7; border-top: 1px solid #f6ad55;">
                        <strong>‚ö†Ô∏è Issues Detected:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            ${player.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <table class="periods-table">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Matches</th>
                                <th>PPG</th>
                                <th>Goals/Game</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${player.periods.map((period, index) => {
                                const isUsedForTrend = player.trendPeriods && 
                                    player.trendPeriods.some(tp => tp.period === period.period);
                                const meetsMinGames = period.matches >= player.tierMinGames;
                                
                                let rowClass = 'period-old';
                                let periodLabel = period.period;
                                
                                if (isUsedForTrend) {
                                    rowClass = index === 0 ? 'period-recent-1' : 'period-recent-2';
                                    periodLabel += ' üéØ'; // Used for trend
                                } else if (meetsMinGames) {
                                    periodLabel += ' ‚úÖ'; // Qualifies but not used
                                } else {
                                    periodLabel += ` ‚ùå (need ${player.tierMinGames}+)`; // Doesn't qualify
                                }
                                
                                return `
                                    <tr class="${rowClass}">
                                        <td><strong>${periodLabel}</strong></td>
                                        <td>${period.matches}</td>
                                        <td class="${getPPGClass(period.ppg)}">${period.ppg.toFixed(1)}</td>
                                        <td>${period.goalsPerGame.toFixed(2)}</td>
                                        <td>${period.attendancePct}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `).join('');
        }
        
        function getRatingClass(value, type) {
            if (value === null) return '';
            
            if (type === 'power') {
                if (value > 20) return 'metric-good';
                if (value < 0) return 'metric-danger';
                return '';
            }
            
            if (type === 'goals') {
                if (value > 0.8) return 'metric-good';
                if (value < 0.2) return 'metric-warning';
                return '';
            }
            
            if (type === 'attendance') {
                if (value > 80) return 'metric-good';
                if (value < 50) return 'metric-danger';
                return '';
            }
            
            return '';
        }
        
        function getPPGClass(ppg) {
            if (ppg > 30) return 'metric-good';
            if (ppg < -10) return 'metric-danger';
            if (ppg < 0) return 'metric-warning';
            return '';
        }
        
        function applyFilters() {
            const tierFilter = document.getElementById('tierFilter').value;
            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
            const issueFilter = document.getElementById('issueFilter').value;
            
            let filteredData = processedData;
            
            if (tierFilter) {
                filteredData = filteredData.filter(p => p.tier === tierFilter);
            }
            
            if (nameFilter) {
                filteredData = filteredData.filter(p => p.name.toLowerCase().includes(nameFilter));
            }
            
            if (issueFilter === 'issues') {
                filteredData = filteredData.filter(p => p.issues.length > 0);
            }
            
            displayData(filteredData);
        }
    </script>
</body>
</html> 